마이크로서비스 아키텍처 구축
<!-- TOC -->

* [마이크로서비스 모델링 방법](#마이크로서비스-모델링-방법)

<!-- TOC -->

# 마이크로서비스 모델링 방법

## MSA는 어디서부터 시작해야 할까?

마이크로서비스는 모듈식 아키텍처의 한 형태다.

1. 중요한 개념인 정보 은닉, 결합, 응집력과 같은 기본 개념과 마이크로서비스 주변의 경계를 그리는 것에 대해서
2. 다양한 분해의 형태
3. DDD와 MSA의 관계

## 올바른 마이크로서비스 경계를 만드는 것은 무엇인가?

본질적으로 마이크로서비스는 모델, 문제 사이에서 네트워크 기반의 상호작용이 이뤄지는 것이고, 모듈식 분해의 다른 형태일 뿐이다.  
경계를 정의하는 방법을 찾는데는 모듈식 소프트웨어와 구조적 프로그래밍 영역에 존재하는 많은 기술을 사용할 수 있다

### 정보 은닉(information hiding)

정보은닉은 모듈 경계를 정의하는 효과적인 방법을 찾으려고 데이비드 피나스가 만든 개념이다.

#### 향상된 개발 시간

모듈을 독립적으로 개발함에 따라 더 많은 작업을 병렬로 수행할 수 있고, 프로젝트에 더 많은 개발자를 추가하는 데 따른 영향을 줄일 수 있다.

#### 이해도

각 모듈을 따로 살펴보고 이해할 수 있다. 이는 시스템 전체가 수행하는 작업을 더 쉽게 이해하도록 해준다.

#### 유연성

모듈은 서로 독립적으로 변경 가능하므로 다른 모듈을 변경하지 않고3 시스템 기능을 변경할 수 있다.

하나의 모듈이 다른 모듈에 대한 결합도를 낮추는 것은 모듈이 다른 모듈에 대한 의존성을 최소화하는 것이다

### 응집도(cohesion)

관령성 있는 행동은 함께 두고, 그렇지 않은 행동은 다른 곳에 두길 원하는 것이다.  
하나의 모듈을 수정 할 때 다른 모듈을 수정할 필요가 없다면, 두 모듈은 서로 독립적이며 각 모듈은 응집도가 높다.

#### 응집도가 낮으면?

1. 기능적 분산: 응집도가 낮은 모듈은 여러 가지 다른 기능을 수행하기 때문에, 이러한 다양한 기능을 수행하려면 다른 모듈과의 상호작용이 필요할 수 있습니다.
   이로 인해 다른 모듈에 대한 의존성이 증가하며, 결과적으로 결합도가 높아질 수 있습니다.

2. 재사용성 저하: 응집도가 낮으면 모듈의 재사용성이 저하됩니다. 모듈이 특정 기능에만 집중하지 않고 여러 기능을 수행하게 되면, 이 모듈을 다른 상황이나 프로젝트에서 재사용하기 어렵게 됩니다.
   이를 보완하기 위해 다른 모듈들과의 상호작용이 증가하며, 결국 결합도가 높아질 수 있습니다.

3. 유지보수의 어려움: 응집도가 낮고 결합도가 높은 시스템은 유지보수가 어렵습니다. 한 모듈을 수정할 때, 다른 모듈에도 영향을 미칠 수 있기 때문에, 변경 사항이 시스템 전체에 파급될 위험이 커집니다.

### 결합도(coupling)

서비스가 느슨하게 결합됐다면 한 서비스를 변경할 때 다른 서비스를 변경할 필요가 없다.  
마이크로서비스의 핵심은 개별 배포가 가능하다는 것이고, 그것은 다른 시스템에 종속적이지 않은 개발이 가능하다는 뜻이다.
예를들면 결제모듈같은 제3자의 외부 서비스를 활용하여 결제를 진행할 떄 외부 서비스에서 어떻게 결제를 진행하는지는 우리 시스템과는 큰 상관이 없다.

### 결합과 응집도의 연관성

결합과 응집력은 개념적으로 관련이 있다.

1. 연관된 기능이 시스템 전체에 분산돼 있다면, 이러한 기능을 수행하기 위해 다른 모듈과의 상호작용이 필요할 수 있고, 이는 결합도를 높인다.

> 응집력이 강하고 결합도가 낮으면 구조가 안정된다.

#### 안전성

응집력은 경계 내부에 있는 요소간의 관계, 결합은 모듈 건너 혹은 MSA 시스템간의 관계를 설명한다.

## 결합 유형

궁극적으로 시스템에서 일부 결합은 피할 수 없다.

![image](https://github.com/Oomool-Expedition/Hyodo-Planner/assets/22822369/c8571385-a0c8-4239-99d4-4c57a0ef25d9)

### 도메인 결합

마이크로 서비스간 제공하는 기능을 사용해야 하므로 상호작용해야 하는 상황을 설명한다.  
도메인 결합은 느슨할 형태의 결합이지만 문제되는 부분은 많은 하위 마이크로서비스와 통신해야 하는 마이크로서비스는 너무 많은 로직이 집중되는 상황을 만든다.  
정보 은닉의 중요성을 명심하고 꼭 필요한 것만 공유하고 필요한 최소한의 데이터만 전송해야 한다.

### 시간적 결합 (temporal coupling)

동시에 발생하기 때문에 함께 엮이는 상황을 나타낸다.
주문서비스와 창고 서비스가 분리되어 있다면 2개의 서비스중 하나가 내려가면 정상적으로 동작하지 못하는 상태가 된다.
카프카 같은 메시지 브로커와 같은 비동기 통신형태로 해당 문제를 많이 해결한다.

### 통과 결합

데이터가 다른 하위 마이크로서비스에 필요하다는 이유만으로 한 마이크로서비스가 다른 마이크로서비스에 데이터를 전달하는 상황

#### 문제점

* 하위에서 데이터를 변경하면 상위에서 더 큰 변경을 일으킬 수 있다는 것이 주요한 문제점이다
    * 마이크로서비스가 중간을 우회하여 호출하는 시도가 합당한가?
    *

### 공통 결합

둘 이상의 마이크로서비스가 공통 데이터 집합을 사용할 때 발생한다.
공통결합은 결국 코드의 응집력이 부족하다는 것을 의마하는 경우가 많다.

* 공유 데이터베이스를 사용하는 경우
* 공유 메모리나 공유 파일 시스템을 사용하는 경우

#### 문제점

1. 데이터 구조를 변경하면 한 번에 여러 마이크로서비스에 영향을 미친다는 것.
   => 요청이 데이터베이스 업데이트와 직접적으로 매핑되는 데이터베이스 연산을 둘러싼 래퍼 비슷하게 작동하는 서비스를 만들어야 한다.
   이 마이크로 서비스의 행동이 상위 소비자들에세 누출돼 다른 여러 서비스를 통해서도 허용된 상태 전환을 관리할 수 있는 세계로 ..?

> 데이터베이스의 CRUD 연산을 둘러싼 래퍼 마이크로서비스가 있다면 해당 서비스에 있어야 할 로직이 시스템의 다른 곳으로 분산되기 때문에 응집력은 약하면서 더 강하게 결합될 수 있다는 신호로 이해해야한다.

2. 리소스 경합

* 공유 자원이 느려지거나 아예 사용할 수 없게 되면 심각한 문제를 일으킬 수 있다.

### 내용 결합

상위 서비스가 하위 서비스의 내부까지 도달해 서비스의 내부 상태를 변경한다.  
다른 마이크로서비스의 데이터베이스에 엑세스 하면 안되는 이유이다.  
![image](https://github.com/Oomool-Expedition/Hyodo-Planner/assets/22822369/8e3d4c73-a836-4127-ad02-3fd478a1e7c3)

마이크로서비스에서는 자유롭게 변경 가능한 부분, 불가능한 부분을 명확하게 분리하는 것이 중요하다.  
데이터베이스를 공유하게되면 정보은닉의 개념이 사라저 버린다.
**내용 결합** 은 피해아 한다.

## DDD (Domain-Driven Design)

마이크로서비스 경계를 찾는데 기본 메커니즘은 DDD를 사용하여 도메인 자체를 중심으로 진행한다.

### 보편 언어 (Ubiquitous Language)

의사소통을 돕기 위해 코드와 도메인 섬령에 사용할 공통 언어를 정의하고 채택한다.

* 사용자가 쓰는 용어를 코드에서도 동일하게 사용하려고 노력해야 한다는 개념
    * 코드와 도메인 모델이 동일한 용어를 사용하면 코드가 도메인 모델을 더 쉽게 모델링하고 의사소통도 향상된다는 것을 의미한다.
    * PO(Proudct Owner)와 개발자가 동일한 용어를 사용하면 개발자가 요구사항을 더 쉽게 이해할 수 있다

### 애그리거트

객체들의 집합이며 일반적으로 실제 세계 개념과 관련된 하나의 개체로 관리된다.

* 애그리거트는 실제 도메인 개념의 표현
    * 애그리거트는 일반적으로 수명주기가 있으므로 상태 기계로 구현할 수 있다.
*

## 경계 콘텍스트

경계 콘텍스트는 복잡한 소프트웨어 시스템 내에서 특정 비즈니스 도메인이나 기능을 명확히 구분하는 데 중요한 개념입니다.   
이는 특히 대규모 시스템이나 마이크로서비스 아키텍처에서 중요한데, 이런 환경에서는 다양한 비즈니스 요구 사항과 기능이 서로 다른 도메인으로 나뉘어 관리되고 개발됩니다.   
경계 콘텍스트는 이러한 도메인 간의 상호작용을 관리하고, 시스템의 복잡성을 효율적으로 관리할 수 있는 구조를 제공합니다.

### **은닉 모델 (Hidden Model)**

은닉 모델은 특정 도메인 또는 경계 콘텍스트 내의 내부 구현 세부 사항을 외부로부터 숨기는 방법입니다.   
이 접근 방식은 도메인의 내부 로직이나 데이터 구조를 외부에 노출하지 않음으로써, 도메인 간의 의존성을 최소화하고, 시스템의 유연성과 확장성을 향상시키는 데 중요합니다.

**장점**

* 한 도메인이 변경되어도 이 변경이 다른 도메인에 영향을 미치는 것을 방지할 수 있습니다.
* 도메인의 내부 구현을 자유롭게 개선하거나 수정할 수 있습니다.

### **공유 모델 (Shared Model)**

공유 모델은 서로 다른 도메인 간에 공유되는 데이터 구조나 인터페이스를 정의합니다.   
이 모델은 특히 도메인 간에 정보를 교환하거나 협업이 필요할 때 중요합니다.   
공유 모델을 설계할 때는 과도한 결합을 피하고, 도메인 간의 독립성을 유지하는 것이 중요합니다.

#### 공유 모델의 역할

* 서로 다른 도메인이 상호 이해할 수 있는 공통의 언어 또는 인터페이스를 제공합니다.
    * 효율적인 데이터 교환과 협업이 가능해집니다.

#### **공유 모델이 너무 많은 세부 사항을 포함하게 되면?**

* 시스템의 유연성이 저하됩니다.
* 변경 사항이 한 도메인에서 다른 도메인으로 파급되는 문제가 발생할 수 있습니다.

## 마이크로서비스와 DDD

1. DDD를 강력하게 만드는 가장 큰 이유는 경계 콘텍스트가 정보은닉에 명시적으로 사용된다는 점입니다.
    * DDD 방식을 따를 때 기본적으로 정보 은닉을 채택한다는 의미며 안정적인 마이크로서비스 경계를 찾는데 매우 중요합니다.
2. 공통적인 보편 언어를 정의하는데 중점을 두는 것은 MSA 엔드포인트를 정의할 때 큰 도움이 됩니다.
    * 이 언어를 통해 API를 설계하고, 마이크로서비스 간의 통신을 관리할 수 있습니다.
    * 이벤트 포맷을 만들때 참고할 분명한 공유 용어를 제공할 수 있습니다.
    * API 표준화 범위에 대한 문제를 해결하는 데도 도움이 됩니다.
3. DDD는 비즈니스 도메인을 우리가 구축하는 소프트웨어의 중심에 둡니다.
    * 비즈니스 언어를 코드와 서비스 설계에 끌어오도록 하면 소프트웨어를 구축하는 사람들 간에 도메인 전문성이 향상됩니다.

# 모놀리스 분해

## 마이크로 서비스는 목표가 아니다

현재 아키텍처로 최종 목표를 달성하는 더 쉬운 방법을 찾을 수 없는 경우에만 마이크로서비스 아키텍처로의 마이그레이션을 생각해야한다.  
마이크로 서비스는 목표가 아니라 도구이고, 마이크로 서비스 도입은 복잡한 문제를 발생하게 만들 수 있다.

## 점진적 마이그레이션

마이크로 서비스로의 전환은 점진적으로 이루어져야 한다.  
기존 모놀리식을 한 번에 조금씩 떼어내는 것이 좋다.

1~2개의 기능 영역을 선택하고 마이크로서비스로 구현해 운영 환경에 배포한 다음, 새 마이크로서비스를 만드는 것이 좋고, 그것이 최종 목표에 더 가까워지는 데 도움이 됐는지 생각해보기

## 모놀리스는 적이 아님

* 폐기해야하는 인프라 스트럭처
* 버리고 싶은 값비싼 제삼자의 시스템인 상황

### 조급한 분해의 위험성

도메인에 대한 이해가 명확하지 않을 때는 마이크로서비스를 생성하는 데 위험이 따른다.  
시스템을 조기에 마이크로서비스로 분해하면 많은 비용이 들게 된다. 도메인을 처음 접하는 경우에는 더욱 그렇다.

## 무엇을 먼저 나눌까?

* 마이크로서비스로 추출하는 작업의 용이성
* 추출의 이점

쉬운쪽에 가까운 것을 선택하는게 초기에는 좋다.
전체 목표를 달성하는 데 어느 정도 영향을 미칠 수 있는 것으로 선택하되, 쉽게 분해할 수 있는 것을 선택하는 것이 좋고  
빠른 성공 경험으로 팀의 동기부여를 높일 수 있다.  

